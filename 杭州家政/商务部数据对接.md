## 建表

```sql
CREATE TABLE `employee_public_credit` (
  `id` varchar(20) NOT NULL COMMENT 'id',
  `id_card` varchar(20) NOT NULL COMMENT '身份证号',
	`name` varchar(15) NOT NULL COMMENT '姓名',
	`certificate` varchar(3000) DEFAULT NULL COMMENT '证书信息',
	`lose_credit` varchar(3000) DEFAULT NULL COMMENT '失信人信息',
	`create_date` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
	`modify_date` TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `emp_card_code` (`id_card`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='人员征信查询表';

CREATE TABLE `merchant_public_credit` (
  `id` varchar(20) NOT NULL COMMENT 'id',
  `merchant_id` varchar(20) NOT NULL COMMENT '商户名称',
	`sc_code` varchar(20) NOT NULL COMMENT '企业统一社会信用代码',
	`general_credit` varchar(3000) DEFAULT NULL COMMENT '通用信用',
	`serious_dishonesty` varchar(3000) DEFAULT NULL COMMENT '严重违法失信',
	`create_date` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
	`modify_date` TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
	UNIQUE KEY `merchant_id_index` (`merchant_id`),
  UNIQUE KEY `sc_code_index` (`sc_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='企业征信查询表';

alter table employee_public_credit modify `certificate` text DEFAULT NULL COMMENT '证书信息';
alter table employee_public_credit modify `lose_credit` text DEFAULT NULL COMMENT '失信人信息';
alter table merchant_public_credit modify `general_credit` text DEFAULT NULL COMMENT '通用信用';
alter table merchant_public_credit modify `serious_dishonesty` text DEFAULT NULL COMMENT '严重违法失信';

alter table employee_public_credit add column `permanent_population` text default null comment '常住人口身份信息';


select count(*) from employee_public_credit where certificate is not null;

select count(*) from employee_public_credit where lose_credit is not null;

```

## 有失信执行人信息的阿姨暂时软删掉

```sql
update `96365_mall`.employee 
SET DEL_FLAG = '0' 
where ID_CARD 
in (
'342101196610252248',
'350125197309020320',
'330124196903024514',
'332627197702260767',
'460025197504040028',
'340405197003010022',
'330719197409173764',
'330123197209161429',
'341021197208036102',
'330623197203132085',
'330127197112272726',
'332625196403255127',
'220223197008080024',
'320811197109021526',
'360281197210077720',
'360621197403186523',
'330121196307080860',
'362321197206198627',
'510213197206271688',
'330822197101196621',
'330825197008093520',
'330126196810123225',
'23100219621223054x',
'33012719650308412x',
'33010419650604134x',
'362301197512044540',
'330125197307256029',
'330127197212120922',
'330121196907278424',
'330123196802041626',
'330122196505172543',
'33012619690606002x',
'330125196903114129',
'330821197407173426',
'330126197206243524',
'330602196902200044',
'340823196803017863',
'332621197404083266',
'330824196911233728',
'332627196909072689',
'332528197409231423',
'330824197605251527',
'330123196604011629',
'34252919730316008X',
'342427197408215827',
'330625196712125164',
'330802196904060445',
'33082119630217142x',
'330522196512230221',
'360423197310020024',
'330821197409096049',
'33082219690109184x',
'330824196303254920',
'330823197607074329',
'330323196406260027',
'330124196504201421',
'412902197708176135'
);

```

## 服务人员硬删除

```sql
delete from employee where ID_CARD 
in ('342101196610252248',
'350125197309020320',
'330124196903024514',
'332627197702260767',
'460025197504040028',
'340405197003010022',
'330719197409173764',
'330123197209161429',
'341021197208036102',
'330623197203132085',
'330127197112272726',
'332625196403255127',
'220223197008080024',
'320811197109021526',
'360281197210077720',
'360621197403186523',
'330121196307080860',
'362321197206198627',
'510213197206271688',
'330822197101196621',
'330825197008093520',
'330126196810123225',
'23100219621223054x',
'33012719650308412x',
'33010419650604134x',
'362301197512044540',
'330125197307256029',
'330127197212120922',
'330121196907278424',
'330123196802041626',
'330122196505172543',
'33012619690606002x',
'330125196903114129',
'330821197407173426',
'330126197206243524',
'330602196902200044',
'340823196803017863',
'332621197404083266',
'330824196911233728',
'332627196909072689',
'332528197409231423',
'330824197605251527',
'330123196604011629',
'34252919730316008X',
'342427197408215827',
'330625196712125164',
'330802196904060445',
'33082119630217142x',
'330522196512230221',
'360423197310020024',
'330821197409096049',
'33082219690109184x',
'330824196303254920',
'330823197607074329',
'330323196406260027',
'330124196504201421',
'412902197708176135'
);

delete from employee_card_code where emp_card_code 
in ('342101196610252248',
'350125197309020320',
'330124196903024514',
'332627197702260767',
'460025197504040028',
'340405197003010022',
'330719197409173764',
'330123197209161429',
'341021197208036102',
'330623197203132085',
'330127197112272726',
'332625196403255127',
'220223197008080024',
'320811197109021526',
'360281197210077720',
'360621197403186523',
'330121196307080860',
'362321197206198627',
'510213197206271688',
'330822197101196621',
'330825197008093520',
'330126196810123225',
'23100219621223054x',
'33012719650308412x',
'33010419650604134x',
'362301197512044540',
'330125197307256029',
'330127197212120922',
'330121196907278424',
'330123196802041626',
'330122196505172543',
'33012619690606002x',
'330125196903114129',
'330821197407173426',
'330126197206243524',
'330602196902200044',
'340823196803017863',
'332621197404083266',
'330824196911233728',
'332627196909072689',
'332528197409231423',
'330824197605251527',
'330123196604011629',
'34252919730316008X',
'342427197408215827',
'330625196712125164',
'330802196904060445',
'33082119630217142x',
'330522196512230221',
'360423197310020024',
'330821197409096049',
'33082219690109184x',
'330824196303254920',
'330823197607074329',
'330323196406260027',
'330124196504201421',
'412902197708176135'
);
```


## 建库建表

```sql

CREATE DATABASE `96365_credit` CHARACTER SET 'utf8' COLLATE 'utf8_general_ci';


CREATE TABLE `employee_credit_verify` (
  `verify_id` varchar(20) NOT NULL COMMENT 'id',
  `id_card` varchar(20) NOT NULL COMMENT '身份证号',
  `name` varchar(15) NOT NULL COMMENT '姓名',
  `permanent` varchar(2) DEFAULT NULL COMMENT '是否是浙江常住人口',
  `lose_credit_count` int(8) DEFAULT NULL COMMENT '失信记录数',
  `certificate` text COMMENT '证书列表',
  `del_flag` varchar(1) NOT NULL DEFAULT '1' COMMENT '逻辑删除',
  `create_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `modify_date` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`verify_id`),
  UNIQUE KEY `emp_card_code` (`id_card`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='服务人员征信核验表';

CREATE TABLE `merchant_credit_verify` (
  `verify_id` varchar(20) NOT NULL COMMENT 'id',
  `sc_code` varchar(20) NOT NULL COMMENT '社会统一信用代码',
  `merchant_name` varchar(45) NOT NULL COMMENT '商户名称',
  `red_count` int(8) DEFAULT NULL COMMENT '红名单记录数',
  `black_count` int(8) DEFAULT NULL COMMENT '黑名单记录数',
  `cf_count` int(8) DEFAULT NULL COMMENT '行政处罚记录数',
  `serious_dishonesty_count` int(8) DEFAULT NULL COMMENT '严重违法失信记录数',
  `lose_credit_count` int(8) DEFAULT NULL COMMENT '法人失信记录数',
  `del_flag` varchar(1) NOT NULL DEFAULT '1' COMMENT '逻辑删除',
  `create_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `modify_date` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`verify_id`),
  UNIQUE KEY `merchant_sc_code` (`sc_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='商户征信核验表';

CREATE TABLE `public_credit_interface_log` (
  `log_id` varchar(20) NOT NULL COMMENT 'id',
	`interface_type` varchar(50) NOT NULL COMMENT '接口类型',
	`interface_url` varchar(200) NOT NULL COMMENT '接口路径',
  `input_dto` varchar(500) NOT NULL COMMENT '入参',
  `output_dto` text DEFAULT NULL COMMENT '返回值',
  `result` varchar(20) NOT NULL DEFAULT 'fail' COMMENT '结果（默认失败）',
  `create_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `modify_date` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`log_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='商务局接口（征信查询接口）日志表';

alter table employee_credit_verify add column health_certificate text DEFAULT NULL COMMENT '健康证列表';


update employee_credit_verify set certificate = null where certificate like '[{"assessmentAchievement":"null"%';

alter table employee_credit_verify add column nation varchar(10) DEFAULT NULL COMMENT '民族' after permanent;
alter table employee_credit_verify add column address varchar(50) DEFAULT NULL COMMENT '住址' after permanent;
alter table employee_credit_verify add column elc_licence_url varchar(1000) DEFAULT NULL COMMENT '证件照' after permanent;

update employee_credit_verify set permanent = NULL where del_flag = '1';

alter table employee_credit_verify ADD COLUMN temporary_permit text DEFAULT NULL COMMENT '暂住证';


-- 添加核验时间
-- 已同步1
ALTER TABLE employee_credit_verify ADD COLUMN permanent_date TIMESTAMP NULL DEFAULT NULL COMMENT '常住人口核验时间' AFTER permanent;

ALTER TABLE employee_credit_verify ADD COLUMN lose_credit_date TIMESTAMP NULL DEFAULT NULL COMMENT '失信执行人记录核验时间' AFTER lose_credit_count;

ALTER TABLE employee_credit_verify ADD COLUMN certificate_date TIMESTAMP NULL DEFAULT NULL COMMENT '职业技能证书核验时间' AFTER certificate;

ALTER TABLE employee_credit_verify ADD COLUMN health_date TIMESTAMP NULL DEFAULT NULL COMMENT '健康证书核验时间' AFTER health_certificate;

ALTER TABLE employee_credit_verify ADD COLUMN temporary_permit_date TIMESTAMP NULL DEFAULT NULL COMMENT '暂住证核验时间' AFTER temporary_permit;


ALTER TABLE merchant_credit_verify ADD COLUMN general_credit_date TIMESTAMP NULL DEFAULT NULL COMMENT '企业通用信用核验时间' AFTER cf_count;

ALTER TABLE merchant_credit_verify ADD COLUMN serious_dishonesty_date TIMESTAMP NULL DEFAULT NULL COMMENT '企业严重违法失信核验时间' AFTER serious_dishonesty_count;

ALTER TABLE merchant_credit_verify ADD COLUMN lose_credit_date TIMESTAMP NULL DEFAULT NULL COMMENT '企业法人失信执行人信息核验时间' AFTER lose_credit_count;
-- 已同步2


ALTER TABLE merchant_credit_verify ADD COLUMN domestic_service VARCHAR(1) DEFAULT NULL COMMENT '是否经营家政服务，0=否，1=是' AFTER lose_credit_date;
ALTER TABLE merchant_credit_verify ADD COLUMN business_license text DEFAULT NULL COMMENT '营业执照核验' AFTER domestic_service;
ALTER TABLE merchant_credit_verify ADD COLUMN business_license_date TIMESTAMP NULL DEFAULT NULL COMMENT '营业执照核验时间' AFTER business_license;


```

## 线上数据库

```sql
alter table employee change alipay_user_id verify_flag varchar(1) DEFAULT NULL COMMENT '信用核查标志，1=已核查';

update employee set verify_flag = null;


-- 信用核查授权
-- 已同步
ALTER TABLE employee ADD COLUMN verify_credit_authorize varchar(10) NOT NULL DEFAULT 'false' COMMENT '信用核验授权true/false';


```

## 杭州家政数据上传

(已同步)
```sql

-- 已同步
ALTER TABLE employee ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

-- 已同步
ALTER TABLE merchant ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

```
(已同步)
```sql

ALTER TABLE basicdata_service ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE certificate ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE data_merchant ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE data_member ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE dimension ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE employee_certificate ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE data_service_scatter ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

ALTER TABLE data_complain_handel ADD COLUMN update_flag_date TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间标志，null=无修改，!null=有修改';

```

<!--核验数据查询sql-->
```sql
-- 商户
-- 已注册
SELECT COUNT(*) FROM merchant;

-- 已核验
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1';

-- 资质核验通过
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND domestic_service = '1';

-- 有红名单
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND red_count > 0;

-- 有黑名单
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND black_count > 0;

SELECT sc_code,merchant_name FROM merchant_credit_verify WHERE del_flag = '1' AND black_count > 0;

-- 有行政处罚记录
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND cf_count > 0;

SELECT sc_code,merchant_name FROM merchant_credit_verify WHERE del_flag = '1' AND cf_count > 0;

-- 有严重违法
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND serious_dishonesty_count > 0;

SELECT sc_code,merchant_name FROM merchant_credit_verify WHERE del_flag = '1' AND serious_dishonesty_count > 0;

-- 法人失信
SELECT COUNT(*) FROM merchant_credit_verify WHERE del_flag = '1' AND lose_credit_count > 0;

SELECT sc_code,merchant_name FROM merchant_credit_verify WHERE del_flag = '1' AND lose_credit_count > 0;

-- 服务人员
-- 已注册
SELECT COUNT(*) FROM employee WHERE DEL_FLAG = '1';

-- 已核验
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1';

-- 常住人口
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1' AND permanent = '1';

-- 居住证
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1'AND temporary_permit IS NOT NULL AND temporary_permit <> '[]';

-- 失信记录
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1' AND lose_credit_count > 0;

SELECT COUNT(*),e.merchant_name
FROM employee_credit_verify ecv 
LEFT JOIN employee e ON ecv.id_card = e.ID_CARD AND e.DEL_FLAG = '1' 
WHERE ecv.del_flag = '1' AND ecv.lose_credit_count > 0 
GROUP BY e.merchant_id;

-- 无失信记录
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1' AND lose_credit_count IS NOT NULL AND lose_credit_count <= 0;

-- 健康证
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1' AND health_certificate IS NOT NULL AND health_certificate <> '[]';

-- 技能证书
SELECT COUNT(*) FROM employee_credit_verify WHERE del_flag = '1' AND certificate IS NOT NULL AND certificate <> '[]';

```


## 健康码开始的需要同步的数据库

```sql

CREATE TABLE `verify_data` (
  `verify_id` varchar(20) NOT NULL COMMENT 'id',
  `identity_id` varchar(50) NOT NULL COMMENT '证件ID',
  `identity_type` varchar(20) NOT NULL COMMENT '证件类型',
  `name` varchar(50) NOT NULL COMMENT '姓名/公司名称',
  `verify_type` varchar(50) NOT NULL COMMENT '核验类型（InterfaceTypeEnum）',
  `verify_data` text COMMENT '核验返回数据',
  `verify_result` varchar(5) NOT NULL COMMENT '核验结果',
  `verify_date` timestamp NULL DEFAULT NULL COMMENT '核验时间',
  `create_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `modify_date` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`verify_id`),
  UNIQUE KEY `verify_index` (`identity_id`,`identity_type`,`verify_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='数据核验记录表';

```

## 上面的已同步

## 鉴权待同步

```sql

CREATE TABLE `application_authority` (
  `authority_id` varchar(20) NOT NULL COMMENT '权限ID',
  `application_id` varchar(100) NOT NULL COMMENT '平台应用ID',
  `private_key` varchar(1000) NOT NULL COMMENT '私钥',
  `public_key` varchar(500) NOT NULL COMMENT '公钥',
  `status` varchar(20) NOT NULL COMMENT '状态',
  `del_flag` varchar(1) NOT NULL DEFAULT '1' COMMENT '逻辑删除',
  `create_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `modify_date` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`authority_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='平台来源鉴权表';

```